



api ,
ActivitychannelRpcService
cms-api
phtoto-upload-end-consumer



新增作品带指定魔表终


com.kuaishou.photo.constant.PhotoLogTopic#PHOTO_EDIT_UPLOAD_ENDED  这个是监听上传信息的topic，里面可以通过PhotoService获取到Photo对象，photo对象里面  com.kuaishou.photo.model.Photo#getMagicFaceIds，一般取第一个就行
魔表sdk的话，依赖kuaishou-api-core-sdk就行，然后MagicFaceService 里面就会有 

com.kuaishou.magicface.service.MagicFaceService#getMagicFaceById 就可以找到这个魔表是否有；但是魔表的场景在端上比较复杂，有魔表对于app也不一定能用，不过进拍摄的时候会有提示



1. checkActivity

	判断条件组中是否有 发送视频带魔表，有，则 判断 是否正确，正确放过。不正确。error 魔表ID： id 输入有误，请输入正确的魔法表情ID


2. 在OperationIndicatorPhotoUploadEndConsumer 新增一个 photoUploadEndedStrategy 处理这个指标，OperationIndicatorBasicCodeEnum.UPLOAD_PHOTO_WITH_MAGIC_FACE


    private Predicate<IndicatorDetailCacheDTO> composePredicateForMagicFaceId(PhotoUploadEndCalculateContext context) {
        return ((Predicate<IndicatorDetailCacheDTO>) dto -> dto.getRegisterCount() > 0)
                .and(dto -> {
                	long photoId = context.getPhotoId();
                	long magicId = 0L;
                	Set<Long> magicIds = photoService.getMagicFaceIds(photoId);
                	if (CollectionUtils.isNotEmpty(magicIds)) {
                		magicId = magicIds.get(0);
                	}
                	return StringUtils.isNotBlank(dto.getTemplateParam())
                        && CollectionUtils.containsAll(magicId, SPLITTER.splitToList(dto.getTemplateParam())))
                })
                .and(dto -> {
                    List<IndicatorRegisterCacheDTO> list = operationIndicatorCacheService
                            .getIndicatorRegisterList(dto.getIndicatorId(), context.getUserId());
                    return CollectionUtils.isNotEmpty(list);
                });
    }
    
select * from operation_indicator order by id desc;

hgetall operation-user-indicator-activities-"-test-userid-dymaticindicatorId
hgetall operation-user-indicator-activities-test-1509606057-79809


INSERT INTO `operation_indicator` (`indicator`, `name`, `register_count`, `type`, `can_callback`, `template_type`, `template_type_desc`, `template_type_unit`, `template_id`, `template_param`, `template_param_desc`, `template_content`, `template_pre_indicator`, `unit`, `unit_type`, `conversion`, `create_time`, `update_time`)
VALUES
    (45, '发视频带指定魔表', 0, 1, 1, 1, '请填写需要的魔表ID', '', 0, '', '', '发视频带指定魔表${content}', 3, '次', 1, 1, 1610942022602, 1610942022602);


    
INSERT INTO `operation_indicator` (`id`, `indicator`, `name`, `register_count`, `type`, `can_callback`, `template_type`, `template_type_desc`, `template_type_unit`, `template_id`, `template_param`, `template_param_desc`, `template_content`, `template_pre_indicator`, `unit`, `unit_type`, `conversion`, `create_time`, `update_time`)
VALUES
  (7305, 45, '发视频带指定魔表', 0, 1, 1, 1, '请填写需要的魔表ID', '', 0, '', '', '发视频带指定魔表${content}', 3, '次', 1, 1, 1610942022602, 1610942022602);


  "9": {
      "1": {
        "0": {
          "desc": "发视频带指定魔表-创作者中心渠道-未参加状态",
          "buttonType": 1,
          "buttonName": "去发布",
          "buttonUrl": "kwai://post?tag=${tag}&returnToWeb=true&returnToOriginalPage=true",
          "icon": "https://static.yximgs.com/udata/pkg/fe/cp-h5/anchor-task-half-icon/icon_magic.png"
        },
        "1": {
          "desc": "发视频带指定魔表-创作者中心渠道-进行中状态",
          "buttonType": 1,
          "buttonName": "去发布",
          "buttonUrl": "kwai://post?tag=${tag}&returnToWeb=true&returnToOriginalPage=true",
          "icon": "https://static.yximgs.com/udata/pkg/fe/cp-h5/anchor-task-half-icon/icon_magic.png"
        },
        "2": {
          "desc": "发视频带指定魔表-创作者中心渠道-已完成状态",
          "buttonType": 2,
          "buttonName": "已完成",
          "buttonUrl": "",
          "icon": "https://static.yximgs.com/udata/pkg/fe/cp-h5/anchor-task-half-icon/icon_magic.png"
        },
        "3": {
          "desc": "发视频带指定魔表-创作者中心渠道-未完成状态",
          "buttonType": 2,
          "buttonName": "未完成",
          "buttonUrl": "",
          "icon": "https://static.yximgs.com/udata/pkg/fe/cp-h5/anchor-task-half-icon/icon_magic.png"
        }
      }
    },

